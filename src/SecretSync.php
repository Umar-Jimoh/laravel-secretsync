<?php

namespace UmarJimoh\SecretSync;

use Illuminate\Support\Facades\Artisan;
use UmarJimoh\SecretSync\Caches\SecretCache;
use UmarJimoh\SecretSync\Helpers\SecretMapper;
use UmarJimoh\SecretSync\Interfaces\SecretProviderInterface;

/*
####################################################################################################
####################################################################################################
####################################################################################################
####################################################################################################
####################################################################################################
####################################################################################################
####################################################################################################
##################################################-.........-+#########+############################
##############################################-..................+####-.+###########################
##########################+---.......+#####+.......................-+-..-###########################
######################-.............#####+.......-###########+..........-###########################
###################+.......--+##########-.....-#################+........###########################
#################+.....-#######+++#####.....-#####+-.....-+######-.......+##########################
################....-####+.......+####-....-####+....++-...-####.........-##########################
###############....+##+.........-####+....-#####...#######..-####+-......-##########################
##############...-##-....-+##########-....#####+..+#######-..##########+++##########################
#############-..-##-...+####+-..#####....-#####+..+#######-..#######################################
#############-..##-..-###-......#####....-####+...............+#####################################
##############.-#+..-##-....--++#####....-####-...............-####.....############################
############+-###-.-##...-####################-.....-##+......-####.....############################
#############..-+#############################-......##+......+####....-############################
##############......---+++++####-.--++#########......##-......+###+....+############################
###############+............####+..........+###+.....--......+###+....-#############################
############+.+####++-------#####.........+######-.........-#####.....+####+++######################
#############-..-++##############-.......+#########++---+######-.....+####-.......-#################
##############-.............#####-........-##################+......##########+-.....###############
############++##+...........#####+...........-############+.......+###############+...+#############
############+..+##################..-##+...........---..........-######.........-###+..#############
#############+....######++########-#######+..................-#######+.............-##-+############
###############-+##+.........-################+-........-+######################+....+##############
##################.............+################################+-.........---+####+..-#############
#################.....-####-....#############################+....................+##-.+############
#################....-######...-################################################-...+#++############
#################.....+##########-....+#####+....-#-...+-......+#######-.......-+##-.-##############
#################+.......+#######+....-#####-....##-.............####-............##+.-#############
###################-........-#####+....+####....+##-....-###.....+##.....+####-....+#+.+############
#####################+-........+###.....###+...-###-...-#####....+#-....#######+++####-+############
#########################+-.....-###....+##....+###-...-#####....-#....-##############++############
############################-....+##+....#-...-####-...-#####....-#....-##############++############
################+-...#######+....+###-...-....#####-...-#####....+#-....########+#####+#############
################+.....-####+.....#####.......+#####-...-#####....+##.....#####+....+################
#################+..............######+.....-######-...-#####....-###.............+#################
###################+..........+########-....+######-...-#####....-####+.........-###################
#######################++++############....-##############################++++######################
######################################-...-#########################################################
##################################+......-##########################################################
##################################+.....+###########################################################
####################################################################################################
####################################################################################################
####################################################################################################
####################################################################################################
####################################################################################################
####################################################################################################
####################################################################################################
####################################################################################################
*/

class SecretSync
{
    public function secretSyncService(SecretProviderInterface $provider): array
    {
        $cache = app(SecretCache::class);
        $secrets = $cache->get();
        $useCache = true;

        if ((empty($secrets))) {
            $secrets = $this->syncFromProvider($provider);
            $useCache = false;
        }

        if (isset($secrets['error'])) {
            return ['error' => $secrets['error']];
        }

        (new SecretMapper)->map($secrets);

        Artisan::call('config:cache');

        if (!$useCache) {
            $cache->store($secrets);
        }

        return $secrets;
    }

    private function syncFromProvider(SecretProviderInterface $provider): array
    {
        $secrets = $provider->getSecrets();

        if (empty($secrets)) {
            return ['error' => "Failed to fetch secret from the provider: " . $provider->name()];
        }

        return $secrets;
    }
}
